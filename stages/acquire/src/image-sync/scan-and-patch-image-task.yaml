version: v1.1.0
steps:
  # Step #1: Perform the vulnerability scan
  - id: print-inputs
    cmd: |
        bash -c 'echo "Generating SBOM for image {{.Values.SOURCE_REGISTRY}}/{{.Values.SOURCE_REPOSITORY}}:{{.Values.SOURCE_IMAGE_TAG}} with digest {{.Values.SOURCE_IMAGE_DIGEST}}"'

  - id: scan-image
    cmd: |
      ghcr.io/aquasecurity/trivy image \
      {{.Run.Registry}}/{{.Values.SOURCE_REPOSITORY}}@{{.Values.SOURCE_IMAGE_DIGEST}} \
      --format sarif \
      --output ./vulnerability-report_{{now | date "2000-01-01"}}.sarif

  # Step 2: Push the vulnerability report to the registry as OCI-referrer
  - id: push-vulnerability-report
    cmd: |
      ghcr.io/oras-project/oras:v1.1.0 attach \
      --artifact-type "application/sarif+json" \
      --annotation "vnd.toddysm.generator.tool=trivy" \
      {{.Run.Registry}}/{{.Values.SOURCE_REPOSITORY}}@{{.Values.SOURCE_IMAGE_DIGEST}} \
      ./vulnerability-report_{{now | date "2000-01-01"}}.sarif
